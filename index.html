<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <title>WebCam Computer Vision</title>
    </head>
<body>
    <script src="opencv.js" type="text/javascript"></script>
    <script type="text/javascript">
        
        const video = document.createElement('video')
        video.setAttribute('id','webcamVideo')
        video.setAttribute('muted','true')

        let canvasNum = 5
        let canvasArr = []
        
        function setupCanvases(width, height){
            for(let i = 0; i < canvasNum; i++){
                let canvas = document.createElement('canvas')
                canvas.setAttribute('id', 'canvas'+i)
                canvas.setAttribute('width', width)
                canvas.setAttribute('height', height)
                document.body.appendChild(canvas)
                canvasArr.push(canvas)
            }
        }

        navigator.getUserMedia = (
            navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia
        );
        
        //request webcam access
        navigator.getUserMedia (
        {
            video: true,
            audio: false
        },
        // success callback
        function(stream) {
            console.log('Successfully got access to camera')
            let {width, height} = stream.getTracks()[0].getSettings()
            console.log("Got (w.h) from stream settings ("+width+", "+height+")")
            video.srcObject = stream
            video.play()

            setupCanvases(width,height)
            
        },
        // fail callback
        function(err) {
            console.log('Failed to get webcam access: '+err)
        }
        );

        function processFrame(timestamp){
            let ctx = canvasArr[0].getContext('2d')
            ctx.drawImage(video, 0, 0, canvasArr[0].width, canvasArr[0].height)

            let mat = cv.imread(canvasArr[0].id)
            let temp_mat = cv.Mat.zeros(mat.rows, mat.cols, cv.CV_8UC3)
            let temp_mat2 = cv.Mat.zeros(mat.rows, mat.cols, cv.CV_8UC3)
            let lines = new cv.Mat()
            let color = new cv.Scalar(200, 150, 150)
            
            //Gray scale
            cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY)
            cv.imshow(canvasArr[1].id, mat)

            //bilateral filter
            cv.bilateralFilter(mat, temp_mat, 7, 50, 50, cv.BORDER_DEFAULT) // cv.bilateralFilter( src, dst, d, sigmaColor, sigmaSpace[, dst[, borderType]] )
            cv.imshow(canvasArr[2].id, temp_mat)

            //Canny
            cv.Canny(temp_mat, mat, 60, 120, 3)
            cv.imshow(canvasArr[3].id, mat)

            //Hough Lines
            cv.HoughLinesP(mat, lines, 1, Math.PI / 180, 2, 0, 0);

            // draw lines 
            for (let i = 0; i < lines.rows; ++i) {
                let startPoint = new cv.Point(lines.data32S[i * 4], lines.data32S[i * 4 + 1])
                let endPoint = new cv.Point(lines.data32S[i * 4 + 2], lines.data32S[i * 4 + 3])
                cv.line(temp_mat2, startPoint, endPoint, color)
            }
            cv.imshow(canvasArr[4].id, temp_mat2)

            mat.delete()
            temp_mat.delete()
            temp_mat2.delete()
            lines.delete()

            window.requestAnimationFrame(processFrame)         
        }

        video.addEventListener('play',(event) =>{
            console.log('Webcam started playing to video element')
            window.requestAnimationFrame(processFrame)
        })

    </script>
</body>
</html>