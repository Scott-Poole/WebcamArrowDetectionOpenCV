<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <title>WebCam Computer Vision</title>
    </head>
<body>
    <video id="webcamVideo" muted></video>
    <canvas id="webcamCanvas"></canvas>
    <canvas id="greyCanvas"></canvas>
    <script src="opencv.js" type="text/javascript"></script>
    <script type="text/javascript">
        const video = document.getElementById('webcamVideo');
        const canvas = document.getElementById('webcamCanvas');
        const gray = document.getElementById('grayCanvas');
        const ctx = canvas.getContext("2d");

        let webcamWidth = 0, webcamHeight = 0

        navigator.getUserMedia = (
            navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia
        );
        
        //request webcam access
        navigator.getUserMedia (
        {
            video: true,
            audio: false
        },
        // success callback
        function(stream) {
            console.log('Successfully got access to camera')
            let {width, height} = stream.getTracks()[0].getSettings()
            console.log("Got (w.h) from stream settings ("+width+", "+height+")")
            video.srcObject = stream
            video.play()

            webcamWidth = width
            webcamHeight = height

            canvas.setAttribute('width', width);
            canvas.setAttribute('height', height);
            
        },
        // fail callback
        function(err) {
            console.log('Failed to get webcam access: '+err)
        }
        );

        function processFrame(timestamp){
            
            ctx.drawImage(video, 0, 0, webcamWidth, webcamHeight);
            //let data = canvas.toDataURL("image/png");
            let src = cv.imread("webcamCanvas");
            //console.log(src)
//
            //let dst = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);  //cv.CV_8UC3
            //let dst2 = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);  //cv.CV_8UC3
            //let lines = new cv.Mat();
            //let colour = new cv.Scalar(200, 150, 150);  // colour do draw output in
//
            cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);  //  Convert the input image to grayscale.
            cv.imshow("greyCanvas", src);

            window.requestAnimationFrame(processFrame);           
        }

        video.addEventListener('play',(event) =>{
            console.log('Webcam started playing to video element')
            window.requestAnimationFrame(processFrame);
        })

    </script>
</body>
</html>